// ==UserScript==
// @name         Play Candy Box
// @namespace    http://ribeirobreno.com.br/
// @version      0.21.0
// @updateURL    https://github.com/ribeirobreno/candy-box-player/raw/master/Play-Candy-Box.meta.js
// @downloadURL  https://github.com/ribeirobreno/candy-box-player/raw/master/Play-Candy-Box.user.js
// @description  Automate some tasks from the first Candy Box game.
// @author       Breno Ribeiro <ribeiro.breno@gmail.com>
// @match        https://candybox2.github.io/candybox/
// @grant        unsafeWindow
// @run-at       document-idle
// ==/UserScript==
!function(t){var n={};function e(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}e.m=t,e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:r})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,n){if(1&n&&(t=e(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(e.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var o in t)e.d(r,o,function(n){return t[n]}.bind(null,o));return r},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},e.p="/",e(e.s=0)}([function(t,n,e){t.exports=e(1)},function(t,n){!function(t,n){"use strict";function e(t){return n.getElementById(t)}function r(t){return n.querySelectorAll(t)||[]}function o(t,n){return(t/n|0)*n}function i(t){return Date.now()+t}var u=!1,l=5,a=36e3,c=0,f=0,s=!0,d=0,p=!1,b="Initialized",v=n.createElement("div"),y=e("quest_button"),h=e("quest_destination"),m=e("eat");function x(t){t.dispatchEvent(new Event("click"))}function _(t){return t&&!t.disabled}function g(t){return t&&"hidden"!==getComputedStyle(t,null).getPropertyValue("visibility")}function w(){return t.quest||{}}function M(){var t=w();return t.getCharacterIndex&&t.getCharacterIndex()||0}function I(){return w().things||[]}function S(){var t=I(),n={},e=0,r=!0,o=!1,i=void 0;try{for(var u,l=t[Symbol.iterator]();!(r=(u=l.next()).done);r=!0)"mob"===(n=u.value).type&&(e+=n.hp||0)}catch(t){o=!0,i=t}finally{try{r||null==l.return||l.return()}finally{if(o)throw i}}return e}function T(t,n){var e=I(),r={},o=!0,i=!1,u=void 0;try{for(var l,a=e[Symbol.iterator]();!(o=(l=a.next()).done);o=!0)if((r=l.value).type===n&&r.text===t)return!0}catch(t){i=!0,u=t}finally{try{o||null==a.return||a.return()}finally{if(i)throw u}}return!1}function C(t){return T(t,"mob")}function O(){var t=I(),n=M()+1;return t.length>n?t[n]:{}}function P(){return O().hp||0}function E(){return"mob"===O().type}function H(n){var e=t.potions;return e&&e.list&&e.list[n]&&e.list[n].nbrOwned?e.list[n].nbrOwned:0}function A(){return h&&h.options?h.options.length:0}function G(){return h?h.selectedIndex:-1}function j(){var t=I()[M()];return t&&t.hp?t.hp:0}function q(){return w().getCharacterMaxHp()}function F(){return q()-j()}function k(){var n=t.farm;return n&&n.lollipopsPlanted?n.lollipopsPlanted:0}function L(){var n=t.candies;return n&&n.nbrOwned?n.nbrOwned:0}function R(){return t.cauldron}function B(){return(j()/q()*100).toFixed(3)+"% of "+q()+"<br>Quest: "+(G()+1)+"/"+A()+"<br>HP/Mobs: "+S()+"/"+c+"<br>Pos: "+M()+"/"+I().length+"<br>Runs left: "+l+"<br>Hut: "+(100*a/36e3).toFixed(3)+"%<br>"+b}v.style='position:fixed;bottom:.5em;right:.5em;border:1px solid #080;background-color:#8F8;color:#030;padding:.125em .25em;text-align:center;font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,monospace;',v.innerHTML="Soon!",n.body.appendChild(v),setTimeout((function n(){if(s=!s,_(y)&&G()>-1&&((tt=t.sword)&&"none"!=tt.name))u&&(u=!1,j()?A()>G()+1?(--l<1||f<=0)&&(l=5,++h.selectedIndex):A()>1&&f<=0&&(l=5,h.selectedIndex=0):G()>0&&(h.selectedIndex=0,l+=5,q()<Number.MAX_SAFE_INTEGER/2&&m&&x(m))),x(y),u=!0;else{var v=r("#sword_with_button button"),B=e("plant_1_lp"),N=e("go_to_hut"),D=e("cauldron_candies_quantity");if(v.forEach((function(t){_(t)&&(b=t.innerText,x(t))})),($=t.shop)&&$.shown)if(k()>=17402&&(H("fireScroll")<10||H("impInvocationScroll")<2&&((Z=t.objects)&&Z.list&&Z.list.magicianHat.have))){var Q=e("buy_scroll");_(Q)&&g(Q)&&(b=Q.innerText,x(Q))}else if(k()/17402<.6){var z=e("buy_10_lollipops");_(z)&&g(z)&&(b=z.innerText,x(z))}if(_(B)&&k()<17402&&x(B),N)(Y=t.lollipops)&&Y.nbrOwned>4e4&&a>0?--a:a=36e3,a<1&&x(N),r("#map button").forEach((function(t){_(t)&&/^(Sword, better sword|Candies, faster candies|Surpass yourself) .+/.test(t.innerHTML)&&(b="Buy: "+t.innerText,x(t))}));if(w().weAreQuestingRightNow){f=w().candiesFound,m&&E()&&(O().max_hp||0)>q()&&(b="Ate ~"+L()+" candies",x(m));var V=function(){var t=I(),n=0,e=!0,r=!1,o=void 0;try{for(var i,u=t[Symbol.iterator]();!(e=(i=u.next()).done);e=!0)"mob"===i.value.type&&++n}catch(t){r=!0,o=t}finally{try{e||null==u.return||u.return()}finally{if(r)throw o}}return n}();r("#quest_potions button").forEach((function(t){if(_(t)){var n=t.innerHTML;(/^Imp invocation scroll.+/.test(n)&&C("GHO")&&!T("IMP","ally")||/^Fire scroll.+/.test(n)&&E()&&P()>100||(V<=c&&E()&&P()>j()||V>2&&M()>3&&C("CGG"))&&/^ Teleport scroll.+ /.test(n)&&F()>50||s&&/^Health potion.+/.test(n)&&F()>50&&S()>=j()||/^Major health potion.+/.test(n)&&F()>100&&S()>=j()||/^Invulnerability potion.+/.test(n)&&C("CGG")&&E()||V>2&&/^Earthquake scroll.+/.test(n)&&C("CGG")||V>2&&/^Turtle potion.+/.test(n)&&!w().turtle&&C("CGG"))&&(b=n,x(t))}})),c=V}if(H("health")<10||H("invulnerability")<1)if(p){var W=e("cauldron_put_into_bottles");_(W)&&(x(W),p=!1)}else if((U=R())&&(U.weAreMixing||U.weAreBoiling||U.candiesInTheCauldron>0||U.lollipopsInTheCauldron>0)){var X=e("cauldron_mix");if(function(){var t=R();return t&&t.weAreMixing}()&&Date.now()>=d){var J=e("cauldron_stop");_(J)&&(x(J),d=0,p=!0)}else _(X)&&x(X)}else if(D){var K=function(t){D.value=t,x(r("#cauldron_actions_put button")[0])};H("health")<10?(K(o(L(),100)),d=i(15e3),b="Cook HP potions until "+d):H("invulnerability")<1&&(K(o(L(),2e3)),d=i(6e4),b="Cook Invulnerability potions until "+d)}}var U,Y,Z,$,tt;h&&G()<0&&(h.selectedIndex=0),setTimeout(n,1e3/60)}),1e3/60),requestAnimationFrame((function t(){v.innerHTML=B(),requestAnimationFrame(t)}))}(unsafeWindow,document)}]);